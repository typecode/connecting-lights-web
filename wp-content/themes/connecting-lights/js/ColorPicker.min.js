(function(e,t,n){n.classes.ColorPicker=function(e){var n,r,i,s,o;n=this;r=t.extend({$e:null,selector:"",src:""},e);i={name:"mod.ColorPicker",$e:r.$e?r.$e:t(r.selector),$canvas:null,canvas:null,context:null,bg:null,pixels:null,width:null,height:null,half_width:null,half_height:null,radius:null,radius_offset:9,dragging:!1,cursorX:0,cursorY:0,$handle:null,handle_width:null,handle_height:null,handleX:0,handleY:0,r:0,g:0,b:0};s={init:function(){var e;i.$canvas=i.$e.find("canvas");i.canvas=i.$canvas[0];i.context=i.canvas.getContext("2d");i.width=i.$canvas.width();i.height=i.$canvas.height();i.half_width=i.width/2;i.half_height=i.height/2;i.radius=i.half_width;i.$handle=i.$e.find(".handle");i.handle_width=parseInt(i.$handle.css("width"),10);i.handle_height=parseInt(i.$handle.css("height"),10);i.canvas.width=i.width;i.canvas.height=i.height;i.bg=new Image;i.bg.onload=function(){i.context.drawImage(i.bg,0,0);i.pixels=i.context.getImageData(0,0,i.width,i.height);n.reset()};i.bg.src=r.src;i.$e.on("mousemove",o.mousemove).on("mousedown",o.mousedown).on("mouseup",o.mouseup);e=i.$e[0];e.addEventListener("touchmove",o.touchmove,!1);e.addEventListener("touchstart",o.touchstart,!1);e.addEventListener("touchend",o.touchend,!1)},set_color_from_pos:function(){var e,t,n,r,o,u,a;s.update_handle();i.pixels||(i.pixels=i.context.getImageData(0,0,i.width,i.height));e=i.pixels.data;t=Math.floor(i.handleX);n=Math.floor(i.handleY);r=4*(i.width*n+t);o=e[r];u=e[r+1];a=e[r+2];i.r=o;i.g=u;i.b=a;i.$e.trigger("color:picked",{r:o,g:u,b:a})},set_random_color:function(){i.cursorX=NI.math.random(0,i.width);i.cursorY=NI.math.random(0,i.height);s.set_color_from_pos()},update_handle:function(){var e,t,n,r;e=i.radius-i.radius_offset;t=i.cursorX-i.half_width;n=i.cursorY-i.half_height;r=Math.sqrt(t*t+n*n);i.handleX=e*(t/r)+i.half_width;i.handleY=e*(n/r)+i.half_height;i.$handle.css({left:i.handleX-i.handle_width/2,top:i.handleY-i.handle_height/2})}};o={mousemove:function(e){var t=i.$canvas.offset();i.cursorX=e.pageX-t.left;i.cursorY=e.pageY-t.top;i.dragging&&s.set_color_from_pos()},mousedown:function(e){i.dragging=!0;i.cursorX&&i.cursorY&&s.set_color_from_pos()},mouseup:function(e){i.dragging=!1},touchmove:function(e){var t,n;t=e.targetTouches[0];n=i.$canvas.offset();i.cursorX=t.pageX-n.left;i.cursorY=t.pageY-n.top;i.dragging&&s.set_color_from_pos();e.preventDefault()},touchstart:function(e){i.dragging=!0},touchend:function(e){i.dragging=!1}};this.reset=function(){s.set_random_color()};s.init();console.log(i)}})(this,this.jQuery,this.page);