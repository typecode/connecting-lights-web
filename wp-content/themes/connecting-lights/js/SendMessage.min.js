(function(e,t,n){function r(e){var t,n,r,i;t=e.length;if(t===0)return!1;while(--t){n=Math.floor(Math.random()*(t+1));r=e[t];i=e[n];e[t]=i;e[n]=r}}n.classes.SendMessage=function(i){var s,o,u,a,f=n.classes.colorutil;s=t.extend({app:null,is_live_stream:!1,is_mobile:!1,$e:null,selector:"",$trigger:null,use_color_picker:function(){var e=document.createElement("canvas");return!!e.getContext&&!!e.getContext("2d")}(),color_picker_src:"",bg_desaturation:.6,prompts:t.isArray(n.classes.prompts)?n.classes.prompts:[],service_url:""},i);o={name:"mod.SendMessage",$e:s.$e?s.$e:t(s.selector),$trigger:s.$trigger,is_mobile:s.is_mobile,is_touch:null,overlay:null,merlin:null,colorpicker:null,prompts:s.prompts,prompts_index:null};u={init:function(){o.is_touch="ontouchstart"in e||e.DocumentTouch&&document instanceof DocumentTouch;o.overlay=new NI.Overlay({flavor:"merlin-overlay",autoflush:!1,closeBtn:!0,isTouchDevice:o.is_touch,onOpen:function(){s.app.events.trigger("overlay:opened")},onClose:function(){s.app.events.trigger("overlay:closed")}});o.overlay.setBody(o.$e.detach());o.$trigger.click(a.trigger_click);if(!t.isArray(o.prompts)||o.prompts.length===0)console.warn("Missing prompts for messages");else{r(o.prompts);o.prompts_index=0}},init_color_picker:function(e){s.use_color_picker?o.colorpicker=new n.classes.ColorPicker({$e:e,src:s.color_picker_src}):e.hide()},set_prompt:function(){var e=o.prompts[o.prompts_index];o.merlin.internal.steps.compose.fields["message[message]"].component.set_val(e)},get_bg_css:function(e,t,n){var r;r=f.rgbToHSV(e,t,n);r.s=r.s*s.bg_desaturation;return f.rgbToString(f.hsvToRGB(r))}};a={trigger_click:function(e,t){e.preventDefault();o.is_touch||o.overlay.open()},load_prompt_click:function(e,t){e.preventDefault();if(typeof o.prompts_index=="number"&&o.prompts.length){o.prompts_index+=1;o.prompts_index>o.prompts.length-1&&(o.prompts_index=0);u.set_prompt()}},color_picked:function(e,t){var n,r,i,s;n=o.merlin;r=t.r;i=t.g;s=t.b;n.set_val("message[red]",r);n.set_val("message[green]",i);n.set_val("message[blue]",s);e.data.container.css({"background-color":u.get_bg_css(r,i,s)})}};o.merlin=new NI.Merlin({name:o.name+" Merlin",$e:o.$e,controls:{prev:".prev",next:".next"},extensions:{data:new NI.MerlinData({uri:s.service_url,data:function(){var e={"message[message]":"","message[red]":null,"message[green]":null,"message[blue]":null};if(s.is_live_stream){e["message[latitude]"]="55.002991";e["message[longitude]"]="-2.390963"}return e}()})},first_step:"info",steps:{info:{selector:".send-message-info",next:"compose"},compose:{selector:".send-message-compose",next:"dispatch",fields:{"message[message]":{selector:"textarea[name=m]",options:{extensions:{Validator:{validators:["required","maxlen=100"]},Counter:{max:100}},handlers:{focus:function(e){t(".control-bar").css("position","absolute")},blur:function(e){t(".control-bar").css("position","fixed")}}}}},init:function(e){var n=e.internal.current_step,r=n.$e.find(".color-picker");e.extensions.data.init(e);o.is_touch?r.on("color:picked",{container:t("body")},a.color_picked):r.on("color:picked",{container:n.$e},a.color_picked);u.init_color_picker(r);n.$e.find(".load-prompt").on("click",a.load_prompt_click)},visible:function(e){o.colorpicker&&o.colorpicker.reset();u.set_prompt();o.is_touch&&t("html, body").animate({scrollTop:0},"slow")},finish:function(e){e.extensions.data.collect_fields(e);o.is_touch&&t("body").css("background","rgb(34,34,34)")}},geo:{selector:".send-message-geo",prev:"compose",next:"dispatch",init:function(e){}},dispatch:{selector:".step.dispatch",visible:function(e){e.extensions.data.post_data(function(t){e.show_step("thank-you")})}},"thank-you":{selector:".step.thank-you",visible:function(t){e.setTimeout(function(){o.overlay.close();o.is_touch?location.reload():t.show_step("compose")},3e3)}}}});u.init();console.log(o)}})(this,this.jQuery,this.page);